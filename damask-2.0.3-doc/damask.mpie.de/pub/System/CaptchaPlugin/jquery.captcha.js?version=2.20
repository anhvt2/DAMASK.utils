"use strict";!function(r){var n={endpoint:null,template:"<img src='{{:url}}' height='{{:height}}' width='{{:width}}' /><input type='hidden' name='captcha_challenge' value='{{:challenge}}' />",captchaContainer:".jqCaptchaContainer",reloadButton:".jqCaptchaReload",challengeName:"captcha_challenge",responseName:"captcha_response",createParams:{width:170,height:65},validateOnSubmit:!0,disableOnSuccess:!1};function e(t,e){var a=this;a.element=t,a.options=r.extend({},n,e),a.init()}e.prototype.load=function(t){var e=this,a=r(e.element).find(e.options.captchaContainer);void 0===t&&(t=!0),r.jsonRpc(e.options.endpoint,{async:t,method:"create",params:e.options.createParams,success:function(t){a.html(e.template.render(t.result))},error:function(t){alert("Error: "+t.error.message)}})},e.prototype.init=function(){var t=this,e=r(t.element);t.template=r.templates(t.options.template),t.load(!1),e.find(t.options.reloadButton).each(function(){r(this).click(function(){return t.unflagError(),t.unflagSuccess(),t.load(!1),e.find("input[name='"+t.options.challengeName+"']").val("").focus(),!1})}),e.bind("reload.captcha",function(){var t=e.data("captcha");t.unflagError(),t.unflagSuccess(),t.load()}),this.options.validateOnSubmit&&e.parents("form:first").submit(function(){return t.validate()}),e.find(t.options.captchaContainer).css({width:t.options.createParams.width,height:t.options.createParams.height})},e.prototype.params=function(t){return void 0===t?this.options.createParams:r.extend(this.options.createParams,t)},e.prototype.validate=function(){var t=this,e=r(t.element),a=e.find("input[name='"+t.options.challengeName+"']"),n=a.val(),i=e.find("input[name='"+t.options.responseName+"']"),o=i.val(),s=!1;return n&&o&&r.ajax({url:foswiki.getScriptUrl("rest","CaptchaPlugin","validate"),async:!1,data:{t:(new Date).getTime(),challenge:n,response:o},success:function(t){s="true"===t}}),s?(t.flagSuccess(),t.options.disableOnSuccess&&(i.attr("disabled","disabled"),a.attr("disabled","disabled"))):(t.load(!1),t.flagError(),i.val("").focus()),s},e.prototype.flagError=function(){var t=this,e=r(t.element);t.unflagSuccess(),e.find("input[name='"+t.options.responseName+"']").addClass("error"),e.find("label.error").show()},e.prototype.unflagError=function(){var t=r(this.element);t.find("input[name='"+this.options.responseName+"']").removeClass("error"),t.find("label.error").hide()},e.prototype.flagSuccess=function(){var t=r(this.element);this.unflagError(),t.find("label.success").show()},e.prototype.unflagSuccess=function(){r(this.element).find("label.success").hide()},r.fn.captcha=function(t){return this.each(function(){r.data(this,"captcha")||r.data(this,"captcha",new e(this,t))})},r(function(){n.endpoint=foswiki.getScriptUrl("jsonrpc","CaptchaPlugin"),r(".jqCaptcha:not(.jqCaptchaInited)").livequery(function(){var t=r(this),e=r.extend({},t.data());t.addClass("jqCaptchaInited").captcha(e)})})}(jQuery);
