"use strict";!function(t){var o={debug:!1,dry:!1,animationClass:"faa-flash animated"};function e(e,i){var n=this;n.elem=t(e),n.icon=n.elem.find(".listyFavButtonIcon"),n.label=n.elem.find(".listyFavButtonLabel"),n.opts=t.extend({},o,i,n.elem.data()),n.init()}e.prototype.log=function(){var o;"undefined"!=typeof console&&this.opts.debug&&((o=t.makeArray(arguments)).unshift("FAV: "),console.log.apply(this,o))},e.prototype.showMessage=function(o,e,i){t.pnotify({title:i,text:e,hide:"error"!==o,type:o,sticker:!1,closer_hover:!1,delay:"error"===o?8e3:2e3})},e.prototype.hideMessages=function(){t.pnotify_remove_all()},e.prototype.setState=function(o){var e=this;function i(i){e.log("success response=",i),e._isSaving=!1,e.icon.children().removeClass(e.opts.animationClass),e.opts.isFavorite=o,e.flagState(o),e.log("triggering changedCollection"),t(document).trigger("changedCollection",{source:e.opts.source,collection:e.opts.collection,web:e.opts.web,topic:e.opts.topic,action:o?"add":"remove"})}function n(t){e.log("error response=",t),e._isSaving=!1,e.icon.children().removeClass(e.opts.animationClass),e.showMessage("error",t.error.message)}e.icon.children().addClass(e.opts.animationClass),e._isSaving=!0,e.opts.dry?window.setTimeout(i,1e3):o?(e.log("new favorite state=",o),t.jsonRpc(foswiki.getScriptUrl("jsonrpc"),{namespace:"ListyPlugin",method:"saveListyItem",params:{name:"",index:"",type:"topic",topic:e.opts.source,collection:e.opts.collection,listyWeb:e.opts.web,listyTopic:e.opts.topic},success:function(o){i(o),e.opts.name=o.result.name,e.showMessage("info",t.i18n("Added to favorites"))},error:function(t){n(t)}})):(e.log("remove favorite state=",o),t.jsonRpc(foswiki.getScriptUrl("jsonrpc"),{namespace:"ListyPlugin",method:"deleteListyItem",params:{name:e.opts.name,topic:e.opts.source,collection:e.opts.collection},success:function(o){i(o),e.log("success response=",o),e.opts.name="",e.showMessage("info",t.i18n("Removed from favorites"))},error:function(t){n(t)}}))},e.prototype.flagState=function(t){var o,e,i,n=this;void 0===t&&(t=n.opts.isFavorite),t?(o=n.opts.unfavicon,e=n.opts.unfavtext,i=n.opts.unfavtitle):(o=n.opts.favicon,e=n.opts.favtext,i=n.opts.favtitle),n.elem.attr("title",decodeURIComponent(i)),n.icon.html(decodeURIComponent(o)),n.label.html(decodeURIComponent(e))},e.prototype.toggleState=function(){this.setState(!this.opts.isFavorite)},e.prototype.init=function(){var o=this;o.log("opts=",o.opts),o.elem.on("click",function(t){return o._isSaving?o.log("save in progress ... ignored click"):(o.log("clicked on favbutton"),o.toggleState()),t.stopPropagation(),!1}),t(document).on("changedCollection",function(t,e){e.source===o.opts.source&&e.collection===o.opts.collection&&e.web===o.opts.web&&e.topic===o.opts.topic&&(o.log("got a changedCollection event with data=",e),void 0!==e.action&&("edit"===e.action||"add"===e.action?o.opts.isFavorite=!0:o.opts.isFavorite=!1,o.flagState()))})},t.fn.favButton=function(o){return this.each(function(){t.data(this,"favButton")||t.data(this,"favButton",new e(this,o))})},t(".jqFavButton").livequery(function(){var e=t(this),i=t.extend({},o,e.data());e.addClass("jqInitedFavButton").favButton(i)})}(jQuery);
