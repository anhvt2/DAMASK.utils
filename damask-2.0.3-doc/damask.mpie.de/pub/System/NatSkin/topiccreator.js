"use strict";!function(r){var s={debug:!1};function t(e,t){var i=this;i.template="newtopic",i.steps=[{id:".tcTopicTypes",select:".tcTopicType"},{id:".tcTopicTemplates",expand:"topiccreator::topictemplates",select:".tcTopicTemplate"},{id:".tcInputForm",expand:"topiccreator::inputform"}],i.elem=r(e),i.container=i.elem.find(".tcContainer"),i.opts=r.extend({topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC")},s,i.elem.data(),t),i.elem.find(".tcNavi").on("click",function(){var e=r(this).attr("href");return"#next"===e?i.gotoStep(i.currentStep+1,1):"#prev"===e?i.gotoStep(i.currentStep-1,-1):console.error("unknown target ",e,"clicking on ",this),!1}),i.elem.find(".tcAbort").on("click",function(){return r(this).parents(".ui-dialog-content:first").dialog("close"),!1}),i.elem.find(".tcSubmit").on("click",function(){return""===i.elem.find("input[name=topic]").val()||r(this).is(".jqButtonDisabled")||(i.container.block({message:""}),i.elem.find("form").submit()),!1});var n=i.steps[0],o=i.container.find(n.id).find(n.select+".tcSelected");o.length&&(n.selectedElem=o),i.gotoStep(0,1)}t.prototype.log=function(){var e;this.opts.debug&&((e=r.makeArray(arguments)).unshift("TC:"),console.log.apply(console,e))},t.prototype.gotoStep=function(t,i){var e,n=this,o={},s=n.steps[t];if(n.log("called gotoStep",t,"dir=",i),t<0||t>n.steps.length||void 0===s)console.error("unknown step "+t);else{for(n.currentStep=t,e=0;e<t;e++)n.steps[e].selectedElem?r.extend(o,n.steps[e].selectedElem.data()):n.log("no selected element in step",e);if(o.topicTitle=n.elem.find("input[name=topicTitle]").val(),0===t||i<0)for(e=t;e<n.steps.length;e++)n.steps[e].expand&&(n.log("removing ",n.steps[e].id),n.elem.find(n.steps[e].id).remove(),delete n.steps[e].selectedElem);s.expand&&0===n.container.find(s.id).length?(n.container.block({message:""}),r.extend(o,n.opts,{name:n.template,expand:s.expand,success:function(e){n.container.unblock(),n.container.append(e),n.initStep(t,i)},error:function(e){console.error("Error: "+e.status+" "+e.statusText)}}),n.log("loading params=",o),foswiki.loadTemplate(o)):n.initStep(t,i)}},t.prototype.initStep=function(e,t){var i,c=this,l=c.steps[e],a=c.container.find(l.id),n=a.find(l.select),o=!1;if(c.log("called initStep() - step=",e,"stepDesc=",l,"currentStep=",c.currentStep,"dir=",t),a.length&&1!==n.length)c.log("got something to select"),c.elem.find(".tcViewPort").scrollTo(l.id,250);else{if(!a.length||1!=n.length)return c.log("nothing to select ... next"),l.isHidden=!0,a.hide(),c.gotoStep(c.currentStep+t,t);c.log("selecting the one element"),l.selectedElem=n,l.isHidden=!0,a.hide(),c.gotoStep(c.currentStep+t,t)}for(i=e-1;0<=i;i--)c.steps[i].isHidden||(o=!0);function s(){var e=a.find("input[name=topic]").val(),t=c.elem.find(".tcSubmit");c.log("topic=",e),""===e?t.addClass("jqButtonDisabled"):t.removeClass("jqButtonDisabled")}o?c.elem.find(".tcNaviPrev").parent().show():c.elem.find(".tcNaviPrev").parent().hide(),e===c.steps.length-1?(c.elem.find(".tcNaviNext").parent().hide(),c.elem.find(".tcAbort, .tcSubmit").show()):(c.elem.find(".tcNaviNext").parent().show(),c.elem.find(".tcAbort, .tcSubmit").hide()),2===e&&c.steps[1].selectedElem&&c.steps[1].selectedElem.data("topicTemplate")&&c.container.find(l.id).find("input[name='templatetopic']").val(c.steps[1].selectedElem.data("topicTemplate")),a.find(".tcLayoutToggle:not(.inited)").on("click",function(){var e=r(this).addClass("inited"),t=e.find(":visible"),i=e.find(":hidden");return t.hide(),i.show(),c.elem.toggleClass("tcListLayout"),sessionStorage.tcListLayout=c.elem.is(".tcListLayout")?"true":"false",a.find("input[type=text]:first").focus(),!1}),("true"==sessionStorage.tcListLayout||c.elem.is(".tcListLayout"))&&(c.elem.addClass("tcListLayout"),a.find(".tcLayoutToggleList").show(),a.find(".tcLayoutToggleGrid").hide()),window.setTimeout(function(){a.find("input[type=text]:first").focus()}),a.data("inited")?c.log("element already inited",l.id):(a.data("inited",1),c.log("init ",l.id),a.find(".tcPage").each(function(){var e=r(this);e.find(".tcSelected").detach().prependTo(e)}),a.find("input[type=text]:not(.jqTextboxList)").on("keyup",function(e){var t,i;if(13===e.keyCode)return i=(t=a.find("form")).find("input[name=topic]").val(),t.length?i&&(c.container.block({message:""}),t.submit()):c.gotoStep(c.currentStep+1,1),!1}),a.on("keydown",function(e){var t,i,n,o=a.find(".tcSelected"),s=a.find(".tcPage");if(0!==o.length){if(c.log("pressed key",e.keyCode),c.elem.is(".tcListLayout"))switch(e.keyCode){case 32:case 39:case 40:n=o.nextAll("div:eq(0)");break;case 37:case 38:n=o.prevAll("div:eq(0)");break;case 9:e.preventDefault()}else switch(e.keyCode){case 32:case 39:n=o.nextAll("div:eq(0)");break;case 40:n=o.nextAll("div:eq(2)");break;case 37:n=o.prevAll("div:eq(0)");break;case 38:n=o.prevAll("div:eq(2)");break;case 9:e.preventDefault()}return n&&n.length?(o.removeClass("tcSelected"),n.addClass("tcSelected"),l.selectedElem=n,t=s.offset(),((i=n.offset()).top+n.outerHeight()>t.top+s.innerHeight()||i.top<t.top)&&a.find(".tcPage").scrollTo(n,250),!1):void 0}}),l.select&&n.on("click",function(){var e=r(this);return n.removeClass("tcSelected"),e.addClass("tcSelected"),l.selectedElem=e,c.log("selected",e.data()),c.gotoStep(c.currentStep+1,1),!1}),a.find(".tcFilter .foswikiInputField").on("keyup",function(){var t=r(this).val().toLowerCase();n.each(function(){var e=r(this);0<=e.text().toLowerCase().indexOf(t)?e.show():e.hide()})}),a.find("input[name=topic]").on("change",s),s())},r.fn.topicCreator=function(e){return this.each(function(){r.data(this,"topicCreator")||r.data(this,"topicCreator",new t(this,e))})},r(".jqTopicCreator:not(.jqInitedTopicCreator)").livequery(function(){r(this).addClass("jqInitedTopicCreator").topicCreator()})}(jQuery);
