"use strict";!function(t){AjaxSolr.AbstractJQueryWidget=AjaxSolr.AbstractWidget.extend({defaults:{},options:{},$target:null,init:function(){var e=this;e.$target=t(e.target),e.options=t.extend({},e.defaults,e.options,e.$target.data())}})}(jQuery),function(r){AjaxSolr.AbstractJQueryFacetWidget=AjaxSolr.AbstractFacetWidget.extend({defaults:{facetType:"facet_fields",facetMincount:1,multiValue:!1,union:!1,exclusion:!1,label:null,exclude:null,include:null,facetSortReverse:!1},options:{},$target:null,facetCounts:[],isSelected:function(e){var t=this.getQueryByKey(e);return t&&(e=t.value),e=e.toString().replace(/^(.*?):/,""),0<=this.inQuery(e)},getQueryByKey:function(e){var t=this;if(t.queries)for(var a=0,n=t.queries.length;a<n;a++)if(t.queries[a].key==e)return t.queries[a]},getQueryByValue:function(e){var t=this;if(t.queries)for(var a=0,n=t.queries.length;a<n;a++)if(t.queries[a].value==e)return t.queries[a]},getFacetCounts:function(){var a=this,e=this._super(),n=[];return 0==a.options.facetMincount?e:(r.each(e,function(e,t){!(t.count>=a.options.facetMincount)||a.options.exclude&&t.facet.match(a.options.exclude)||a.options.include&&!t.facet.match(a.options.include)||n.push(t)}),a.options.facetSortReverse?n.reverse():n)},init:function(){var e=this;switch(e.$target=r(e.target),e.options=r.extend({},e.defaults,e.options,e.$target.data()),e.facetType=e.options.facetType,e["facet.mincount"]=e.options.facetMincount,e["facet.sort"]=e.options.facetSort,e["facet.prefix"]=e.options.facetPrefix,e["facet.limit"]=e.options.facetLimit,e["facet.offset"]=e.options.facetOffset,e["facet.missing"]=e.options.facetMissing,e["facet.method"]=e.options.facetMethod,e["facet.enum.cache.minDf"]=e.options.facetEnumCacheMinDf,e.facetType){case"facet_dates":e["facet.date.start"]=e.options.facetDateStart,e["facet.date.end"]=e.options.facetDateEnd,e["facet.date.gap"]=e.options.facetDateGap,e["facet.date.hardend"]=e.options.facetDateHardend,e["facet.date.other"]=e.options.facetDateOther,e["facet.date.include"]=e.options.facetDateInclude;break;case"facet_ranges":e["facet.range.start"]=e.options.facetRangeStart,e["facet.range.end"]=e.options.facetRangeEnd,e["facet.range.gap"]=e.options.facetRangeGap,e["facet.range.hardend"]=e.options.facetRangeHardend,e["facet.range.other"]=e.options.facetRangeOther,e["facet.range.include"]=e.options.facetRangeInclude}e.key=e.options.label,e.field=e.options.field;var t=e.manager.store.get("fl"),a=t.val();(null==a?t.val([e.field]):a.push(e.field),e.options.union&&(e.multivalue=!0,e.union=e.options.union),e.options.multiValue?(e.tag=e.tag||e.field,e.multivalue=!0):e.multivalue=!1,e.options.exclusion&&(e.tag=e.tag||e.field,e.ex=e.tag),void 0!==e.options.defaultValue)&&e[e.multivalue?e.union?"append":"add":"set"].call(e,e.options.defaultValue);e._super()}})}(jQuery),function(i){AjaxSolr.FacetFieldWidget=AjaxSolr.AbstractJQueryFacetWidget.extend({defaults:{templateName:"#solrFacetFieldTemplate",container:".solrFacetFieldContainer",filterField:".solrFacetFieldFilter>input",hideNullValues:!0,hideSingle:!0,name:null,dateFormat:null},facetType:"facet_queries",template:null,container:null,filterField:null,paramString:null,inputType:null,initQueries:function(){var e=i(this.target).find(".solrJsonData").text();e&&(this.queries=i.parseJSON(e))},getFacetValue:function(e){var t=this.getQueryByKey(e);return t&&t.value?t.value:e},getFacetKey:function(e){var t;return this.options.dateFormat?i.datepicker.formatDate(this.options.dateFormat,new Date(e)):(t=this.getQueryByValue(e))&&t.key?t.key:_(e)},afterRequest:function(){var n=this,e=n.manager.store.string().replace(/&?start=\d*/g,"");if(n.paramString!=e)if(n.paramString=e,n.facetCounts=n.getFacetCounts(),0!=n.facetCounts.length)if(this.options.hideSingle&&1==n.facetCounts.length)n.$target.hide();else{if(n.container.html(n.template.render({widget:n},{checked:function(e){return n.isSelected(e)?"checked='checked'":""},selected:function(e){return n.isSelected(e)?"selected='selected'":""},getFacetValue:function(e){return n.getFacetValue(e)},getFacetKey:function(e){return n.getFacetKey(e)}})),n.$target.fadeIn(),n.container.find("input[type='"+n.inputType+"'], select").change(function(){var e=i(this),t=e.attr("title"),a=e.val();"facet_ranges"==n.facetType&&(a=a+" TO "+a+n["facet.range.gap"],t&&AjaxSolr.Dicts.default.set(a,t),a="["+a+"]"),""==a?(n.clear(),n.manager.doRequest(0)):e.is(":checked, select")?n.clickHandler(a).call(n):n.unclickHandler(a).call(n)}),n.filterField&&n.filterField.is(":visible")){var t=n.filterField.val();void 0!==t&&n.container.find(".jqSerialPager").data("filter",t)}n.$target.children("h2").each(function(){var e=i(this).text();e&&AjaxSolr.Dicts.default.set(n.field,e)})}else n.$target.hide()},init:function(){var n,r=this;r.initQueries(),r._super(),r.template=i.templates(r.options.templateName),r.container=r.$target.find(r.options.container),r.filterField=r.$target.find(r.options.filterField),r.inputType="checkbox",r.$target.addClass("solrFacetContainer"),r.$target.find(".solrFacetFieldTwisty").on("afterClose.twisty",function(){void 0!==r.filterField.val()&&r.container.find(".jqSerialPager").trigger("refresh"),r.filterField.blur()}).on("afterOpen.twisty",function(){var e=r.filterField.val();void 0!==e&&r.container.find(".jqSerialPager").trigger("refresh",e),r.filterField.focus()}),r.filterField.on("keyup",function(e){var t=i(this).val(),a=r.container.find(".jqSerialPager");a.length&&(void 0!==n&&(clearTimeout(n),n=void 0),n=window.setTimeout(function(){a.trigger("refresh",t),n=void 0},250))})}}),AjaxSolr.Helpers.build("FacetFieldWidget")}(jQuery),jQuery,AjaxSolr.WebFacetWidget=AjaxSolr.FacetFieldWidget.extend({facetType:"facet_fields",keyOfValue:{},getFacetKey:function(e){var t=this.keyOfValue[e];return t||e},getFacetCounts:function(){for(var e,t=this._super(),a=0,n=t.length;a<n;a++)e=t[a].facet,this.keyOfValue[e]=t[a].key=_(e.replace(/\./g,"/"));return"title"===this.options.facetSort&&t.sort(function(e,t){var a=e.key.toLowerCase(),n=t.key.toLowerCase();return a<n?-1:n<a?1:0}),t}}),AjaxSolr.Helpers.build("WebFacetWidget"),function(t){AjaxSolr.ToggleWidget=AjaxSolr.AbstractJQueryWidget.extend({options:{templateName:"#solrToggleTemplate",value:null,inverseValue:null,inverse:!1},checkbox:null,remove:function(){return this.manager.store.remove(this.field),!0},add:function(e){return this.manager.store.add(this.field,new AjaxSolr.Parameter({name:this.field,value:e}))},isSelected:function(e){var t=!1,a=this.manager.store.get(this.field);if(void 0!==a)if(AjaxSolr.isArray(a)){for(var n=0,r=a.length;n<r;n++)if(a[n].val()===e){t=!0;break}}else t=a.val()===e;return t},afterRequest:function(){var e=this;e.isSelected(e.options.value)?e.options.inverse?e.checkbox.prop("checked",!1):e.checkbox.prop("checked",!0):e.options.inverse?e.checkbox.prop("checked",!0):e.checkbox.prop("checked",!1)},clickHandler:function(e){var t=this;return function(){return t.add(e)&&t.doRequest(0),!1}},unclickHandler:function(){var e=this;return function(){return e.remove()&&e.doRequest(0),!1}},init:function(){var e=this;e._super(),e.$target.append(t(e.options.templateName).render({id:AjaxSolr.Helpers.getUniqueID(),title:e.options.title})),e.checkbox=e.$target.find("input[type='checkbox']").change(function(){t(this).is(":checked")?e.options.inverse?(e.unclickHandler(e.options.value).call(e),e.options.inverseValue&&e.clickHandler(e.options.inverseValue).call(e)):(e.clickHandler(e.options.value).call(e),e.options.inverseValue&&e.unclickHandler(e.options.inverseValue).call(e)):e.options.inverse?(e.clickHandler(e.options.value).call(e),e.options.inverseValue&&e.unclickHandler(e.options.inverseValue).call(e)):(e.unclickHandler(e.options.value).call(e),e.options.inverseValue&&e.clickHandler(e.options.inverseValue).call(e))}),e.options.inverse?(e.add(e.options.value),e.options.inverseValue&&e.remove(e.options.inverseValue)):(e.options.inverseValue&&e.add(e.options.inverseValue),e.remove(e.options.value))}}),AjaxSolr.Helpers.build("ToggleWidget")}(jQuery),function(t){AjaxSolr.ToggleFacetWidget=AjaxSolr.AbstractJQueryFacetWidget.extend({options:{templateName:"#solrToggleFacetTemplate",value:null,inverseValue:null,inverse:!1},checkbox:null,afterRequest:function(){var e=this;e.isSelected(e.options.value)?e.options.inverse?e.checkbox.prop("checked",!1):e.checkbox.prop("checked",!0):e.options.inverse?e.checkbox.prop("checked",!0):e.checkbox.prop("checked",!1)},init:function(){var e=this;e._super(),e.$target.append(t(e.options.templateName).render({id:AjaxSolr.Helpers.getUniqueID(),title:e.options.title})),e.checkbox=e.$target.find("input[type='checkbox']").change(function(){t(this).is(":checked")?e.options.inverse?(e.unclickHandler(e.options.value).call(e),e.options.inverseValue&&e.clickHandler(e.options.inverseValue).call(e)):(e.clickHandler(e.options.value).call(e),e.options.inverseValue&&e.unclickHandler(e.options.inverseValue).call(e)):e.options.inverse?(e.clickHandler(e.options.value).call(e),e.options.inverseValue&&e.unclickHandler(e.options.inverseValue).call(e)):(e.unclickHandler(e.options.value).call(e),e.options.inverseValue&&e.clickHandler(e.options.inverseValue).call(e))}),e.options.inverse?(e.add(e.options.value),e.options.inverseValue&&e.remove(e.options.inverseValue)):(e.options.inverseValue&&e.add(e.options.inverseValue),e.remove(e.options.value))}}),AjaxSolr.Helpers.build("ToggleFacetWidget")}(jQuery),function(d){AjaxSolr.PagerWidget=AjaxSolr.AbstractJQueryWidget.extend({defaults:{prevText:"Previous",nextText:"Next"},perPage:function(){return parseInt(this.manager.response.responseHeader&&this.manager.response.responseHeader.params&&this.manager.response.responseHeader.params.rows||this.manager.store.get("rows").val()||10)},clickHandler:function(t){var a=this;return function(){var e=t*a.perPage();return a.manager.doRequest(e),!1}},afterRequest:function(){var e,t,a,n,r=this,i=r.manager.response,o=i.responseHeader,s=parseInt(o.params&&o.params.rows||20),l=parseInt(i.response.numFound),c=parseInt(o.params&&o.params.start||0);if(r.$target.empty(),(n=Math.ceil(l/s)-1)<=0)r.$target.hide();else{r.$target.show(),0<(a=Math.ceil(c/s))?d("<a href='#' class='solrPagerPrev'>"+r.options.prevText+"</a>").click(r.clickHandler(a-1)).appendTo(r.$target):r.$target.append("<span class='solrPagerPrev foswikiGrayText'>"+r.options.prevText+"</span>"),e=a-4,n<=(t=a+4)&&(e-=t-n+1,t=n),e<0&&(t-=e,e=0),n<t&&(t=n),0<e&&d("<a href='#'>1</a>").click(r.clickHandler(0)).appendTo(r.$target),1<e&&r.$target.append("<span class='solrPagerEllipsis'>&hellip;</span>"),1,"";for(var u=e;u<=t;u++)d("<a href='' class='"+(u==a?"current":"")+"'>"+(u+1)+"</a>").click(r.clickHandler(u)).appendTo(r.$target),0;t<n-1&&r.$target.append("<span class='solrPagerEllipsis'>&hellip;</span>"),t<n&&d("<a href='#' class='"+(a==n?"current":"")+"'>"+(n+1)+"</a>").click(r.clickHandler(n)).appendTo(r.$target),a<n?d("<a href='#' class='solrPagerNext'>"+r.options.nextText+"</a>").click(r.clickHandler(a+1)).appendTo(r.$target):r.$target.append("<span class='solrPagerNext foswikiGrayText'>"+r.options.nextText+"</span>")}}}),AjaxSolr.Helpers.build("PagerWidget")}(jQuery),function(i){AjaxSolr.AlphaPagerWidget=AjaxSolr.AbstractJQueryFacetWidget.extend({defaults:{allText:"All",union:!0,title:"alpha",exclusion:!0,enableScroll:!1,scrollTarget:".solrPager:first",scrollSpeed:250},getCurrentVal:function(){for(var e,t,a,n=this.manager.store.values("fq"),r=0,i=n.length;r<i;r++)if(a=(t=n[r].match(/^(?:{!.*?})?(.*?):(.*)$/))[1],e=t[2],a===this.field)return e},afterRequest:function(){var a,n=this,r=n.getCurrentVal()||"";n.$target.empty(),n.facetCounts=n.getFacetCounts(),i("<a href='#' class='"+(a=r?"":"current")+"'>"+n.options.allText+"</a>").click(n.unclickHandler(r)).appendTo(n.$target),i.each(n.facetCounts.sort(function(e,t){var a=e.facet.toUpperCase(),n=t.facet.toUpperCase();return a<n?-1:n<a?1:0}),function(e,t){a=r==t.facet?"current":"",i("<a href='#' class='"+a+"'>"+t.facet+"</a>").on("click",n.clickHandler(t.facet)).appendTo(n.$target)})},init:function(){this._super(),AjaxSolr.Dicts.default.set(this.field,this.options.title)}}),AjaxSolr.Helpers.build("AlphaPagerWidget")}(jQuery),function(s){AjaxSolr.ResultsPerPageWidget=AjaxSolr.AbstractJQueryWidget.extend({defaults:{rows:20,templateName:"#solrResultsPerPageTemplate"},template:null,afterRequest:function(){var t=this,e=t.manager.store.get("rows").val(),a=t.manager.response.responseHeader,n=parseInt(t.manager.response.response.numFound),r=parseInt(a.params&&a.params.rows||20),i=parseInt(a.params&&a.params.start||0),o=i+r;n<o&&(o=n),t.$target.empty(),t.$target.append(t.template.render({from:i+1,to:o,count:n})),0<n?t.$target.find(".solrRows").show().find("option[value='"+e+"']").prop("selected",!0).end().find("select").change(function(){var e=s(this).val();t.manager.store.get("rows").val(e),t.manager.doRequest(0)}):t.$target.find(".solrRows").hide()},init:function(){var e=this;if(e._super(),e.template=s.templates(e.options.templateName),!e.template)throw"template "+e.options.templateName+" not found"}}),AjaxSolr.Helpers.build("ResultsPerPageWidget")}(jQuery),function(s){AjaxSolr.ResultWidget=AjaxSolr.AbstractJQueryWidget.extend({defaults:{blockUi:"#solrSearch",firstLoadingMessage:"Loading ...",loadingMessage:"",displayAs:".solrDisplay",defaultDisplay:"list",dateFormat:"dddd, Do MMMM YYYY, HH:mm",dictionary:"default",enableScroll:!0,scrollTarget:".solrSearchHits"},scrollIntoView:function(){var e;this.options.enableScroll&&(e=s(this.options.scrollTarget)[0]).getBoundingClientRect().top<0&&e.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})},beforeRequest:function(){var e=this;foswiki.getPreference("PUBURLPATH"),foswiki.getPreference("SYSTEMWEB");e._isFirst?s.blockUI({message:"<h1>"+_(e.options.firstLoadingMessage,e.options.dictionary)+"</h1>"}):s(e.options.blockUi).block({message:"<h1>"+_(e.options.loadingMessage,e.options.dictionary)+"</h1>"})},getSnippet:function(e){return e.text?e.text.substr(0,300)+" ...":""},afterRequest:function(){var o=this,a=o.manager.response;o._isFirst?(o._isFirst=!1,s.unblockUI()):s(o.options.blockUi).unblock(),s("#solrSearch").is(":visible")||s("#solrSearch").fadeIn(),s.each(a.response.docs,function(e,t){var a=t.container_web,n=t.container_topic;"topic"===t.type&&(t.url=foswiki.getScriptUrl("view",t.web,t.topic)),void 0!==a&&void 0!==n||void 0!==t.container&&t.container_id.match(/^(.*)\.(.*)$/)&&(a=RegExp.$1,n=RegExp.$2),void 0!==a&&void 0!==n&&(t.container_url=foswiki.getScriptUrl("view",a,n))}),o.$target.html(s("#solrHitTemplate").render(a.response.docs,{debug:function(e){return console.log(e||"",this),""},encodeURIComponent:function(e){return encodeURIComponent(e)},getTemplateName:function(){var e,t,a,n,r,i,o=this.data.field_TopicType_lst||[];for(a=0,r=this.data.type.length;a<r;a++){if("topic"==(e=this.data.type[a].replace(/%\d+/g,""))){for(t=0,n=o.length;t<n;t++)if(i="#solrHitTemplate_"+o[t],s(i).length)return i;return"#solrHitTemplate_topic"}if(e.match(/png|gif|jpe?g|tiff|bmp/))return"#solrHitTemplate_image";if(e.match(/comment/))return"#solrHitTemplate_comment";if(e.match(/listy/))return"#solrHitTemplate_listy";if(s(i="#solrHitTemplate_"+e).length)return i}return"#solrHitTemplate_misc"},renderList:function(e,t,a){var n,r=this.data[e],i="";return t=t||", ",a=a||10,r&&r.length&&(n=[],s.each(r.sort().slice(0,a),function(e,t){n.push(_(t,o.options.dictionary))}),i+=n.join(t),r.length>a&&(i+=" ...")),i},renderTopicInfo:function(){var a,e=this.data.field_Category_title_lst,t=this.data.tag,n="";return e&&e.length&&(n+='<i class="fa fa-folder" /> ',a=[],s.each(e.sort().slice(0,10),function(e,t){a.push(_(t,o.options.dictionary))}),n+=a.join(", "),10<e.length&&(n+=" ...")),t&&t.length&&(e&&e.length&&(n+=" &#124; "),n+='<i class="fa fa-tag" /> ',n+=t.sort().slice(0,10).join(", "),10<t.length&&(n+=" ...")),n},getHilite:function(e){var t;return void 0===a.highlighting?"":void 0===(t=a.highlighting[e])||void 0===t.text?"":(t=t.text.join(" ... "))||""},formatDate:function(e,t){return/^\d+$/.test(e)&&(10==e.length&&(e+="000"),e=new Date(parseInt(e)).toISOString()),void 0===e||""==e||"0"==e||"1970-01-01T00:00:00Z"==e?"???":moment(e).format(t||o.options.dateFormat)},contains:function(e,t){return 0<=s.inArray(t,e)}})),o.$target.trigger("update"),o.scrollIntoView()},update:function(){var e=this,t=s(e.options.displayAs).filter(":checked");e.$target.removeClass("solrSearchHitsList solrSearchHitsGrid"),"list"==e.options.defaultDisplay&&!t.length||"list"==t.val()?e.$target.addClass("solrSearchHitsList"):e.$target.addClass("solrSearchHitsGrid")},init:function(){var e=this;e._super(),s(e.options.displayAs).change(function(){e.update()}),s(e.options.displayAs).filter("[value='"+e.options.defaultDisplay+"']").prop("checked",!0),e._isFirst=!0,e.update()}}),AjaxSolr.Helpers.build("ResultWidget")}(jQuery),function(e){AjaxSolr.SearchBoxWidget=AjaxSolr.AbstractTextWidget.extend({defaults:{instantSearch:!1,instantSearchDelay:1e3,instantSearchMinChars:3},$input:null,doRequest:!1,intervalID:null,afterRequest:function(){var e=this.manager.store.get("q");e&&this.$input&&this.$input.val(e.val())},installAutoSumbit:function(){var e=this;e.intervalID&&window.clearInterval(e.intervalID),e.intervalID=window.setInterval(function(){e.doRequest&&e.$target.submit()},e.options.instantSearchDelay)},init:function(){var t=this;t._super(),t.$target=e(t.target),t.$input=t.$target.find(".solrSearchField"),t.options=e.extend({},t.defaults,t.options,t.$target.data()),t.options.instantSearch&&(t.installAutoSumbit(),t.$input.bind("keydown",function(){t.installAutoSumbit(),t.$input.val().length>=t.options.instantSearchMinChars&&(t.doRequest=!0)})),t.$target.submit(function(){var e=t.$input.val();return t.set(e)&&(t.doRequest=!1,t.manager.doRequest(0)),!1})}}),AjaxSolr.Helpers.build("SearchBoxWidget")}(jQuery),function(n){AjaxSolr.CurrentSelectionWidget=AjaxSolr.AbstractJQueryWidget.extend({options:{defaultQuery:"",templateName:"#solrCurrentSelectionTemplate",keywordText:"keyword"},template:null,selectionContainer:null,getKeyOfValue:function(e,t){var a,n,r=t.replace(/^[\(\[]?(.*?)[\]\)]?$/,"$1"),i=this.manager.response.responseHeader.params,o=["facet.field","facet.query","facet.date"],s=/\s*([^=]+)='?([^'=]+)'?\s*/g;for(var l in t=t.replace(/([\[\]\.\*\?\+\-\(\)])/g,"\\$1"),o)for(var c in i[o[l]])if(n=i[o[l]][c].match("^{!(.*)}\\w+:"+t))for(n=n[1];null!=(a=s.exec(n));)if("key"==a[1])return a[2];if("web"==e){for(var u=r.split(/ /),d=(l=0,u.length);l<d;l++)u[l]=_(u[l].replace(/\./g,"/"));return u.join(", ")}return _(r)},afterRequest:function(){var e,t,a,n,r=this,i=r.manager.store.values("fq"),o=r.manager.store.get("q").val(),s=0;r.clearSelection(),o&&o!==r.options.defaultQuery&&(s++,r.addSelection(r.options.keywordText,o,function(){r.manager.store.get("q").val(r.options.defaultQuery),r.manager.doRequest(0)}));for(var l=0,c=i.length;l<c;l++)i[l]&&!r.manager.store.isHidden("fq="+i[l])&&(s++,t=(e=i[l].match(/^(?:{!.*?})?(.*?):(.*)$/))[1],a=e[2],n=r.getKeyOfValue(t,a),r.addSelection(t,n,r.removeFacet(t,a)));s&&(r.$target.find(".solrNoSelection").hide(),r.$target.find(".solrClear").show())},clearSelection:function(){this.selectionContainer.children().not(".solrNoSelection").remove(),this.$target.find(".solrNoSelection").show(),this.$target.find(".solrClear").hide()},addSelection:function(e,t,a){e.match(/^([\-\+])/)&&(e=e.substr(1),t=RegExp.$1+t),this.selectionContainer.append(n(this.template.render({id:AjaxSolr.Helpers.getUniqueID(),field:_(e),facet:t})).change(a))},removeFacet:function(e,t){var a=this;return function(){a.manager.store.removeByValue("fq",e+":"+AjaxSolr.Parameter.escapeValue(t))&&a.manager.doRequest(0)}},init:function(){var e=this;e._super(),e.template=n.templates(e.options.templateName),e.selectionContainer=e.$target.children("ul:first"),e.$target.find(".solrClear").click(function(){e.clearSelection()})}}),AjaxSolr.Helpers.build("CurrentSelectionWidget")}(jQuery),function(t){AjaxSolr.SortWidget=AjaxSolr.AbstractJQueryWidget.extend({defaults:{defaultSort:"score desc"},update:function(e){e=e||this.defaults.defaultSort,this.manager.store.addByValue("sort",e)},afterRequest:function(){var e,t=this.manager.store.get("sort");t&&(e=t.val()),e=e||this.defaults.defaultSort,this.$target.find("option").prop("selected",!1),this.$target.find("[value='"+e+"']").prop("selected",!0)},init:function(){var e=this;e._super(),t.extend(e.defaults,e.$target.data()),"score desc"!=e.defaults.defaultSort&&e.manager.store.addByValue("sort",e.defaults.defaultSort),e.$target.change(function(){e.update(t(this).val()),e.manager.doRequest(0)})}}),AjaxSolr.Helpers.build("SortWidget")}(jQuery),function(l){AjaxSolr.TagCloudWidget=AjaxSolr.AbstractJQueryFacetWidget.extend({defaults:{title:"title not set",buckets:20,offset:11,container:".solrTagCloudContainer",normalize:!0,facetMincount:1,facetLimit:100,templateName:"#solrTagCloudTemplate",startColor:[104,144,184],endColor:[0,102,255]},$container:null,template:null,facetType:"facet_fields",getFacetCounts:function(){var e,n=this,t=n._super(),r=-1,a=0,i=1,o={};l.each(n.getQueryValues(n.getParams()),function(e,t){o[t.replace(/^"(.*)"$/,"$1")]=!0}),l.each(t,function(e,t){n.options.normalize?t.normCount=Math.log(t.count):t.normCount=t.count,t.normCount>a&&(a=t.normCount),(t.normCount<r||r<0)&&(r=t.normCount)}),(e=a-r)&&(i=e/(n.options.buckets-1)),t.sort(function(e,t){var a=e.facet.toLowerCase(),n=t.facet.toLowerCase();return a<n?-1:n<a?1:0});var s="";return l.each(t,function(e,t){var a=t.facet.substr(0,1).toUpperCase();t.weight=Math.round((t.normCount-r)/i)+n.options.offset+1,t.color=n.fadeRGB(t.weight),a==s?t.group="":(t.group=" <strong>"+a+"</strong>&nbsp;",s=a),t.current=o[t.facet]?"current":""}),t},fadeRGB:function(e){var t=this,a=t.options.buckets+t.options.offset;return"rgb("+Math.round(t.options.startColor[0]*(a-e)/a+t.options.endColor[0]*e/a)+","+Math.round(t.options.startColor[1]*(a-e)/a+t.options.endColor[1]*e/a)+","+Math.round(t.options.startColor[2]*(a-e)/a+t.options.endColor[2]*e/a)+")"},afterRequest:function(){var a=this,e=a.getFacetCounts();e.length?(a.$target.show(),a.$container.empty(),a.$container.append(a.template.render(e)),a.$container.find("a").click(function(){var e=l(this),t=l(this).text();return e.is(".current")?a.unclickHandler(t).apply(a):a.clickHandler(t).apply(a),!1})):a.$target.hide()},init:function(){var e=this;e._super(),e.$container=e.$target.find(e.options.container),e.template=l.templates(e.options.templateName),e.multivalue=!0}}),AjaxSolr.Helpers.build("TagCloudWidget")}(jQuery),function(o){AjaxSolr.HierarchyWidget=AjaxSolr.AbstractJQueryFacetWidget.extend({defaults:{templateName:"#solrHierarchyTemplate",container:".solrHierarchyContainer",breadcrumbs:".solrHierarchyBreadcrumbsContainer",hideNullValues:!1,hideSingle:!1,name:null},updateHierarchy:function(){var i,t=this;return void 0===t.hierarchy&&(o.ajax({url:foswiki.getPreference("SCRIPTURL")+"/rest/SolrPlugin/webHierarchy",async:!1,data:{web:t.options.web},success:function(e){t.hierarchy=e}}),i=AjaxSolr.Dicts.default,o.each(t.hierarchy,function(e,t){var a=t.id,n=t.title,r=t.id.split(/\s*\.\s*/).pop();i.set(a,n),i.set(r,n)})),t.hierarchy},getChildren:function(e){var n=this,r=[];return void 0!==e?void 0!==n.hierarchy[e].children&&void 0!==n.hierarchy[e]&&o.each(n.hierarchy[e].children,function(e,t){var a=n.hierarchy[t];n.options.hideNullValues&&!n.facetCounts[t]||r.push(a)}):o.each(n.hierarchy,function(e,t){void 0!==t.parent||n.options.hideNullValues&&!n.facetCounts[t.id]&&"web"!=t.type||r.push(t)}),r.sort(function(e,t){return e.title<t.title?-1:e.title>t.title?1:0})},afterRequest:function(){var e,t,a=this,n={},r=[],i=[];a.$target.hide(),a.facetCounts=a.getFacetCounts(),void 0!==a.facetCounts&&0!=a.facetCounts.length&&(o.each(a.facetCounts,function(e,t){n[t.facet]=t.count}),a.facetCounts=n,this.options.hideSingle&&1==a.facetCounts.length||void 0!==(t=a.getQueryValues(a.getParams()))&&(void 0===(t=t[0])&&(void 0!==a.options.web&&(t=a.options.web),void 0!==a.options.root&&(t+="."+a.options.root)),a.breadcrumbs.empty(),r.push("<a href='#' class='solrFacetValue root' data-value='"+t+"'>"+_("Root")+"</a>"),void 0!==t&&o.each(t.split(/\s*\.\s*/),function(e,t){i.push(t),r.push("<a href='#' class='solrFacetValue' data-value='"+i.join(".")+"'>"+_(t)+"</a>")}),a.breadcrumbs.append(r.join("&nbsp;&#187; ")),e=a.getChildren(t),a.$target.show(),a.container.html(a.template.render(e,{renderFacetCount:function(e){var t=a.facetCounts[e];return t?"<span class='solrHierarchyFacetCount'>("+t+")</span>":""},getCategory:function(e){return a.hierarchy[e]},getChildren:function(){return a.getChildren(this.data.id)}})),void 0!==t&&a.container.find("a.cat_"+t.replace(/\./g,"\\.")).addClass("current"),a.container.parent().find("a").click(function(){var e=o(this),t=o(this).data("value");return e.is(".root")?a.unclickHandler(t).apply(a):a.clickHandler(t).apply(a),!1})))},init:function(){var e=this;e._super(),e.template=o.templates(e.options.templateName),e.container=e.$target.find(e.options.container),e.breadcrumbs=e.$target.find(e.options.breadcrumbs),e.updateHierarchy()}}),AjaxSolr.Helpers.build("HierarchyWidget")}(jQuery),function(a){AjaxSolr.SpellcheckWidget=AjaxSolr.AbstractSpellcheckWidget.extend({defaults:{spellcheck:!0,"spellcheck.count":3,"spellcheck.collate":!0,"spellcheck.onlyMorePopular":!1,"spellcheck.maxCollations":3,"spellcheck.maxCollationTries":10,templateName:"#solrSpellCorrectionTemplate"},options:{},$target:null,template:null,beforeRequest:function(){this._super(),this.$target.empty()},handleSuggestions:function(){var e=this;e.$target.html(e.template.render({suggestions:e.suggestions})),e.$target.find("a").click(function(){return e.manager.store.addByValue("q",a(this).text()),e.manager.doRequest(0),!1})},init:function(){var e=this;for(var t in e.$target=a(e.target),e.options=a.extend({},e.defaults,e.options,e.$target.data()),e.template=a.templates(e.options.templateName),e.options)t.match(/^spellcheck/)&&e.manager.store.addByValue(t,e.options[t])}}),AjaxSolr.Helpers.build("SpellcheckWidget")}(jQuery);
