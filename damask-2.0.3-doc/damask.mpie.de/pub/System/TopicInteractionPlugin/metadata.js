"use strict";!function(e){void 0===e.detectOS&&(e.detectOS={Windows:-1!==navigator.platform.indexOf("Win"),MacOS:-1!==navigator.platform.indexOf("Mac"),Linux:-1!==navigator.platform.indexOf("Linux"),Unix:-1!==navigator.platform.indexOf("X11"),OS:null},e.detectOS.Windows?e.detectOS.OS="Windows":e.detectOS.Linux?e.detectOS.OS="Linux":e.detectOS.MacOS?e.detectOS.OS="MacOS":e.detectOS.UNIX&&(e.detectOS.OS="Unix"))}(jQuery),function(t){function i(e,t){var i;return"msoffice"===t?e=(i=function(e){switch(function(e){var t,i=e.indexOf("?");-1<i&&(e=e.substr(0,i));if(1===(t=e.split(".")).length)return"";return t.pop()}(e).toLowerCase()){case"docx":case"doc":case"docm":case"dot":case"dotm":case"dotx":case"odt":return"ms-word";case"xltx":case"xltm":case"xlt":case"xlsx":case"xlsm":case"xlsb":case"xls":case"xll":case"xlam":case"xla":case"ods":return"ms-excel";case"pptx":case"pptm":case"ppt":case"ppsx":case"ppsm":case"pps":case"ppam":case"ppa":case"potx":case"potm":case"pot":case"odp":return"ms-powerpoint";case"accdb":case"mdb":return"ms-access";case"xsn":case"xsf":return"ms-infopath";case"pub":return"ms-publisher";case"vstx":case"vstm":case"vst":case"vssx":case"vssm":case"vss":case"vsl":case"vsdx":case"vsdm":case"vsd":case"vdw":return"ms-visio";case"mpp":case"mpt":return"ms-project";default:return""}}(e)+":ofe|u|")+e.replace(/^.*:/,window.location.protocol):"libreoffice"===t&&(i="vnd.sun.star.webdav:",e=e.replace(/^.*:/,i)),e}t(function(){t(".jqWebDAVLink").livequery(function(){var e=t(this);(t.detectOS.Windows||t.detectOS.MacOS)&&e.on("click",function(){var e=i(t(this).attr("href"),foswiki.getPreference("TopicInteractionPlugin").officeSuite||"msoffice");return t("<iframe />").hide().attr("src",e).appendTo("body"),!1})})})}(jQuery),function(c){var n={showHidden:!1,showOptions:!1,showEmpty:!1,sort:"name",filter:"",limit:6,skip:0,cols:1,debug:!1};function t(e,t){var i=this;i.elem=c(e),i.opts=c.extend({},n,i.elem.data(),t),i.log("new FoswikiAttachments opts=",i.opts),i.init()}t.prototype.log=function(){var e;console&&this.opts.debug&&((e=c.makeArray(arguments)).unshift("FA:"),console.log.apply(console,e))},t.prototype.init=function(){var e,s=this;s.log("called init()"),s.container=s.elem.parent(),s.optionsButton=s.elem.find(".foswikiAttachmentsOptionsToggle"),s.optionsLabel=s.optionsButton.find("span:last")||s.optionsButton,s.toggleContainer=s.elem.find(".foswikiAttachmentsOptionsToggleContainer"),s.toggleOpts=c.extend({},s.optionsButton.metadata(),s.optionsButton.data()),s.pager=s.elem.find(".foswikiAttachmentsPager"),s.selection=[],void 0!==s.opts.selection&&""!==s.opts.selection&&(s.selection=s.opts.selection.split(/\s*,\s*/)),s.elem.parent().parent().parent().each(function(){e=c(this).data("tabPane")}),s.opts.showEmpty||0<s.getCount()?(s.elem.find(".foswikiAttachmentsSelectAll").show(),e&&(e.showTab(".attachments"),1===e.elem.find(">.jqTab").length&&e.switchTab(".attachments"))):e&&e.hideTab(".attachments"),s.displayAttachmentsCount(),s.showSelection(),s.elem.on("refresh",function(e,t){return s.log("got refresh event"),t&&(s.log("refreshing from files",t),s.clearSelection(),c.each(t,function(e,t){"string"==typeof t?s.select(t,!0):s.select(t.name,!0)})),s.load(),!1}),s.optionsButton.on("click",function(){return s.toggleContainer.is(":visible")?s.hideOptionsContainer():s.showOptionsContainer(),!1}),s.elem.find(".foswikiDisplayHidden input").on("change",function(){return s.load({showempty:!0,showhidden:c(this).prop("checked")}),!1}),s.elem.find(".foswikiFilter input").on("keypress",function(e){var t,i=c(this);if(13===e.keyCode)return"none"===(t=i.val())&&(t=""),s.load({showempty:!0,filter:t}),e.preventDefault(),!1}),s.elem.find(".foswikiSortBy select").on("change",function(){var e=c(this);return s.load({skip:0,sort:e.val()}),!1}),s.elem.find(".foswikiResultsPerPage select").on("change",function(){var e=c(this);return s.load({skip:0,limit:e.val()}),!1}),s.pager.find("a").on("click",function(){var e=c(this);return s.load({skip:s.getSkip(e)}),!1}),s.elem.find(".foswikiAttachment").hover(function(){c(this).addClass("foswikiAttachmentHover")},function(){c(this).removeClass("foswikiAttachmentHover")}).on("click",function(e){var t=c(this),i=t.data("id");if(!c(e.target).is("a,img,i"))return t.toggleClass("foswikiSelected"),t.hasClass("foswikiSelected")?s.select(i):s.clear(i),e.stopPropagation(),!1}),s.elem.find(".foswikiAttachmentsSelectAll").on("click",function(){return s.log("clicked select all"),s.selection=[],s.elem.find("input.foswikiAttachmentsAll").each(function(){s.selection.push(c(this).data("id"))}),c(this).hide(),s.showSelection(),!1}),s.elem.find(".foswikiAttachmentsClearAll").on("click",function(){return s.clearSelection(),s.elem.find(".foswikiAttachmentsSelectAll").show(),!1}),s.elem.find(".foswikiAttachmentPreviewButton").on("click",function(){var e,t=c(this).parents(".foswikiAttachment:first"),i=s.getAttachmentData(t),n=i.filename.replace(/^.+\./,"");return e=n.match(/mp3|wav/)?"audio":n.match(/flv|swf|mp4|mpe?g|mov|ogg|webm|ogv/)?"video":n.match(/vsd/)?"visio":"document",c.blockUI({message:"<h1>"+c.i18n("Loading preview ...")+"</h1>",fadeIn:0,fadeOut:0}),Dialog.load({expand:"attachments::previewer::"+e,data:{filename:decodeURIComponent(i.filename)}}).done(function(e){c.unblockUI(),e.parent().find(".ui-dialog-title").text(decodeURIComponent(i.filename))}),!1}),s.elem.find(".foswikiAttachmentDeleteButton").on("click",function(){var e=c(this).parents(".foswikiAttachment:first"),t=s.getAttachmentData(e),i=e.find(".foswikiThumbnail").clone().removeClass("foswikiLeft");return Dialog.load({id:"#foswikiAttachmentConfirmDelete",expand:"attachments::confirmdelete",init:function(){var e=this;e.find("#deleteAttachment").text(decodeURIComponent(t.filename)),e.find("input[name=filename]").val(decodeURIComponent(t.filename)),0===i.find(".foswikiAlert").length&&e.find(".foswikiThumbnailContainer").html(i),e.dialog("option","position","center")}}),!1}),s.elem.find(".foswikiAttachmentEditButton").on("click",function(e){e.stopPropagation()}),s.elem.find(".foswikiAttachmentPropertiesButton").on("click",function(){var e=c(this).parents(".foswikiAttachment:first"),n=s.getAttachmentData(e),o=e.find(".foswikiThumbnail").clone().removeClass("foswikiLeft");return Dialog.load({id:"#foswikiAttachmentEditor",expand:"attachments::editor",init:function(){var e=this,t=e.find("input[name=hidefile]"),i=e.find("input[name=isthumbnail]");e.find("input[name=origfilename]").val(decodeURIComponent(n.filename)),e.find("input[name=filename]").val(decodeURIComponent(n.filename)),e.find("input[name=filecomment]").val(decodeURIComponent(n.filecomment)),0===o.find(".foswikiAlert").length&&e.find(".foswikiThumbnailContainer").html(o),n.filename.match(/\.(gif|jpe?g|png|bmp|svg|webp|tiff?)$/i)?e.find(".foswikiThumbnailStep").show():e.find(".foswikiThumbnailStep").hide(),n.fileattr.match(/h/)?t.prop("checked",!0):t.prop("checked",!1),n.fileattr.match(/t/)?i.prop("checked",!0):i.prop("checked",!1),e.dialog("option","position","center")}}),!1}),s.elem.find(".foswikiAttachmentMoveButton").on("click",function(){var e=c(this).parents(".foswikiAttachment:first"),t=s.getAttachmentData(e),i=e.find(".foswikiThumbnail").clone().removeClass("foswikiLeft");return Dialog.load({id:"#foswikiAttachmentMove",expand:"attachments::moveattachment",init:function(){this.find("input[name=filename]").val(decodeURIComponent(t.filename)),0===i.find(".foswikiAlert").length&&this.find(".foswikiThumbnailContainer").html(i),this.find(".foswikiGenericThumbnail").hide(),this.dialog("option","position","center")}}),!1}),s.elem.find(".foswikiAttachmentsBulkAction select").on("change",function(){var t,i,e=c(this),o=e.val(),a=s.selection?s.selection.length:0;if(a&&o){if(e.val(""),"createlink"===o)i=".foswikiAttachmentBulkCreateLinks";else if("createlink_hidefile"===o)i=".foswikiAttachmentBulkCreateLinksHideFile",t="on",o="createlink";else if("createimagegallery"===o)i=".foswikiAttachmentBulkCreateImageGallery";else if("download"===o)i=".foswikiAttachmentBulkDownload";else if("hide"===o)i=".foswikiAttachmentBulkHide";else if("unhide"===o)i=".foswikiAttachmentBulkUnHide";else if("delete"===o)i=".foswikiAttachmentBulkDelete";else if("move"!==o)return void alert("unknown action "+o);"move"!==o?Dialog.load({id:"#foswikiAttachmentConfirmBulk",expand:"attachments::confirmbulkaction",init:function(){var e=this,n=e.find("form");n.find("input[type='hidden'][name='filename']").remove(),n.find("input[type='hidden'][name='hidefile']").val(t),c.each(s.selection,function(e,t){var i=decodeURIComponent(c("#data_"+t).data("filename"));void 0!==i&&c("<input type='hidden' name='filename' />").val(i).prependTo(n)}),e.find("input[name='action']").val(o),n.attr("action",foswiki.getScriptUrl("rest","TopicInteractionPlugin",o)),e.find(".foswikiAttachmentBulkMessage").hide(),e.find(i).show().find("b").text(a),e.dialog("option","position","center")}}):Dialog.load({id:"#foswikiAttachmentMove",expand:"attachments::moveattachment",init:function(){var e=this,n=e.find("form");n.find("input[type='hidden'][name='filename']").remove(),c.each(s.selection,function(e,t){var i=decodeURIComponent(c("#data_"+t).data("filename"));void 0!==i&&c("<input type='hidden' name='filename' />").val(i).prependTo(n)}),e.find(".foswikiAttachmentsCount").text(s.selection.length),e.find(".foswikiThumbnailContainer").empty(),e.find(".foswikiGenericThumbnail").show(),e.dialog("option","position","center")}})}}),s.elem.find(".foswikiShowVersions").each(function(){var e=c(this),t=e.parents(".foswikiAttachment:first"),i=s.getAttachmentData(t),n=t.find(".foswikiVersionsContainer"),o=foswiki.getScriptUrl("rest","RenderPlugin","template"),a={name:"metadata",render:"on",topic:s.opts.topic,expand:"attachments::versions",filename:i.filename};e.on("click",function(){return n.is(".foswikiVersionsContainerLoaded")?(e.hide(),t.find(".foswikiHideVersions").show(),n.slideDown("fast")):(n.show(),n.load(o,a,function(){n.addClass("foswikiVersionsContainerLoaded"),t.effect("highlight"),e.hide(),t.find(".foswikiHideVersions").show()})),!1})}),s.elem.find(".foswikiHideVersions").each(function(){var e=c(this),t=e.parents(".foswikiAttachment:first"),i=t.find(".foswikiVersionsContainer");e.on("click",function(){return e.hide(),t.find(".foswikiShowVersions").show(),i.slideUp("fast"),!1})}),c("#foswikiAttachmentEditorForm").livequery(function(){var e=c(this);e.ajaxForm({dataType:"json",beforeSubmit:function(){e.parent().dialog("close"),c.blockUI({message:"<h1>"+c.i18n("Saving changes ...")+"</h1>",fadeIn:0,fadeOut:0})},success:function(){c.unblockUI(),s.load()},error:function(e,t){try{t=c.parseJSON(e.responseText).error.message}catch(e){}c.unblockUI(),c.pnotify({title:c.i18n("Edit failed"),text:t,type:"error"})}})}),c("#foswikiAttachmentConfirmDeleteForm").livequery(function(){var i,e=c(this);e.ajaxForm({dataType:"json",beforeSubmit:function(){e.parent().dialog("close"),i=e.find("input[name='filename']").val(),c.blockUI({message:"<h1>"+c.i18n("Deleting %file% ...",{file:i})+"</h1>",fadeIn:0,fadeOut:0})},success:function(){c.unblockUI(),s.clear(i),s.load()},error:function(e,t){try{t=c.parseJSON(e.responseText).error.message}catch(e){}c.unblockUI(),c.pnotify({title:c.i18n("Failed to delete %file%",{file:i}),text:t,type:"error"})}})}),c("#foswikiAttachmentMoveForm").livequery(function(){var e=c(this);e.ajaxForm({dataType:"json",beforeSubmit:function(){e.parent().dialog("close"),c.blockUI({message:"<h1>"+c.i18n("Moving attachment(s) ...")+"</h1>",fadeIn:0,fadeOut:0})},success:function(){c.unblockUI(),s.clearSelection(),s.load()},error:function(e,t){try{t=c.parseJSON(e.responseText).error.message}catch(e){}c.unblockUI(),c.pnotify({title:c.i18n("Move failed"),text:t,type:"error"})}})}),c("#foswikiAttachmentConfirmBulkForm").livequery(function(){var e,i,t=c(this);t.ajaxForm({dataType:"json",beforeSubmit:function(){e=t.find(".foswikiAttachmentBulkMessage:visible .foswikiAttachmentBulkProgressMessage").html(),i=t.find("input[name='action']").val(),t.parent().dialog("close"),c.blockUI({message:"<h1>"+e+" ...</h1>",fadeIn:0,fadeOut:0})},success:function(e){c.unblockUI(),"createlink"===i||"createlink_hidefile"===i||"createimagegallery"===i?window.location.href=foswiki.getScriptUrl("view",foswiki.getPreference("WEB"),foswiki.getPreference("TOPIC")):"download"===i?window.location.href=e.result:("delete"===i&&s.clearSelection(),s.load())},error:function(e,t){try{t=c.parseJSON(e.responseText).error.message}catch(e){}c.unblockUI(),c.pnotify({title:c.i18n("Error during '%action%'",{action:i}),text:t,type:"error"})}})})},t.prototype.getCount=function(){return this.pager.length?this.pager.data("count"):0},t.prototype.getSkip=function(e){return(e=e||this.pager.find("a.current")).length?e.data("skip"):0},t.prototype.getAttachmentData=function(e){var t;return"string"==typeof e?e=c(t=e):t=e.data("id"),c("#data_"+t).data()},t.prototype.displayAttachmentsCount=function(){var e=this.getCount();return e?this.elem.parents(".foswikiMetaData:first").find(".foswikiAttachmentsCount").text("("+e+")").show():this.elem.parents(".foswikiMetaData:first").find(".foswikiAttachmentsCount").text("").hide(),e},t.prototype.load=function(e){var t,i=this,n={},o=c.Deferred();return i.log("called load()"),c.each(e,function(e,t){n["attachments_"+e]=t}),e=c.extend({name:"metadata",render:"on",topic:i.opts.topic,expand:"attachments",attachments_showhidden:i.opts.showHidden,attachments_showoptions:i.opts.showOptions,attachments_showempty:i.opts.showEmpty,attachments_sort:i.opts.sort,attachments_reverse:"date"===i.opts.sort,attachments_filter:encodeURI(i.opts.filter),attachments_limit:i.opts.limit,attachments_skip:i.getSkip(),attachments_cols:i.opts.cols,attachments_selection:i.selection.join(", ")},n),t=foswiki.getScriptUrl("rest","RenderPlugin","template"),i.elem.block({message:null,fadeIn:0,fadeOut:0,overlayCSS:{cursor:"progress"}}),i.container.load(t,e,function(){i.elem.unblock(),i.container.height("auto"),i.elem.removeData("FoswikiAttachments"),o.resolve()}),o.promise()},t.prototype.showSelection=function(){var e,t,i=this;if(i.log("showSelection",i.selection),i.elem.find(".foswikiSelected").removeClass("foswikiSelected"),i.selection){for(e=0;e<i.selection.length;e++)t=i.selection[e],c("#attachment_"+t).addClass("foswikiSelected");i.selection.length?(i.elem.find(".foswikiAttachmentsBulkAction, .foswikiAttachmentsClearAll").show(),i.elem.find(".foswikiAttachmentsSelected").text(i.selection.length)):i.elem.find(".foswikiAttachmentsBulkAction, .foswikiAttachmentsClearAll").hide()}else i.elem.find(".foswikiAttachmentsBulkAction, .foswikiAttachmentsClearAll").hide()},t.prototype.select=function(e,t){var i=this;e&&(e=e.replace(/[^0-9a-zA-Z_]/g,"_"),void 0===i.selection&&(i.selection=[]),i.selection.push(e),t||(i.selection.length===i.getCount()&&i.elem.find(".foswikiAttachmentsSelectAll").hide(),i.showSelection()))},t.prototype.clear=function(e){var t=this;if(t.selection)for(var i=0;i<t.selection.length;i++)if(t.selection[i]===e){t.selection.splice(i,1);break}t.elem.find(".foswikiAttachmentsSelectAll").show(),t.showSelection()},t.prototype.clearSelection=function(){this.selection=[],this.showSelection()},t.prototype.hideOptionsContainer=function(){this.optionsLabel.html(c.i18n("Show options")),this.toggleContainer.slideUp({easing:"easeInOutQuad",duration:"fast"}),this.opts.showOptions=!1},t.prototype.showOptionsContainer=function(){this.optionsLabel.html(c.i18n("Hide options")),this.toggleContainer.slideDown({easing:"easeInOutQuad",duration:"fast"}),this.opts.showOptions=!0},c(function(){c(".foswikiAttachments.foswikiFormSteps:not(.foswikiInitedAttachments)").livequery(function(){var e=c(this);void 0===e.data("foswikiAttachments")&&e.data("foswikiAttachments",new t(this)),e.addClass("foswikiInitedAttachments")})})}(jQuery);
